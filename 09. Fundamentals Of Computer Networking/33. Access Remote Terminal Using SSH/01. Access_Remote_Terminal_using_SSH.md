

# üîê Access Remote Terminal using SSH ‚Äî In-depth notes

Nice ‚Äî let‚Äôs dig deep into SSH (Secure Shell). Below you‚Äôll get a practical, technical, and well-organized set of notes: what SSH is, how it *sits on top of TCP*, the client/server pieces, auth methods, commands, tunneling, hardening and troubleshooting. I‚Äôve included command examples and recommended settings so you can use this as a cheat-sheet / study note. üöÄ

---

# üß≠ What is SSH? (Overview)

SSH ‚Äî Secure Shell ‚Äî is a network protocol for secure remote login and other secure network services over an insecure network. It replaces older insecure remote access tools (telnet, rlogin). SSH provides confidentiality, integrity and authentication by encrypting the session and verifying identities.

* Default transport: **TCP** (reliable, ordered byte stream).
* Default port: **22** (but you can run SSH on any TCP port).
* Main uses: interactive shell, remote command execution, secure file copy (SCP), file transfer (SFTP), port forwarding/tunneling, remote administration (rsync-over-ssh, Git over SSH).

---

# üß© SSH Protocol Architecture (SSH-2)

SSH-2 is the modern version and is layered:

1. **Transport Layer (RFC 4253)**

   * Provides server authentication (host keys), confidentiality (symmetric encryption), integrity (MACs), and key exchange (KEX).
   * Negotiates algorithms and establishes an encrypted channel.

2. **User Authentication Layer (RFC 4252)**

   * Handles how the client proves who they are: password, public-key, hostbased, keyboard-interactive, GSSAPI, certificates.

3. **Connection Layer (RFC 4254)**

   * Multiplexes multiple logical channels (shell, exec, subsystems like SFTP, port forwardings) over the single encrypted transport.

Sequence (simplified): TCP handshake ‚Üí SSH version/banner exchange ‚Üí KEX (Diffie-Hellman / ECDH / Curve25519) ‚Üí establish symmetric keys ‚Üí authenticate user ‚Üí open channels.

---

# üì° How SSH uses TCP

* SSH **runs on top of TCP**. It depends on TCP‚Äôs reliable, ordered delivery and congestion control. That makes it suitable for an interactive terminal and multiplexed streams.
* Default server listens on TCP port 22. You connect to `host:22` unless you specify `-p` or change server config.
* Because SSH is TCP-based, NAT and firewalls require TCP port forwarding or rules to allow inbound TCP connections to the SSH server.

---

# üñ•Ô∏è Client & Server ‚Äî components & key files

* **Client**: `ssh` (OpenSSH client), PuTTY (Windows), `sftp`, `scp`, `ssh-keygen`, `ssh-agent`.

  * Client config: `~/.ssh/config`.
* **Server**: `sshd` (OpenSSH server) listens for connections and enforces `sshd_config`.

  * Server config: `/etc/ssh/sshd_config`.
  * Host keys: `/etc/ssh/ssh_host_*_key` (private) and `.pub` (public).
* **User files**:

  * `~/.ssh/authorized_keys` ‚Äî server side list of allowed public keys.
  * `~/.ssh/known_hosts` ‚Äî client side store of known server host keys.
  * `~/.ssh/id_*` ‚Äî private keys (client).
  * Permissions are critical: `~/.ssh` ‚Üí `700`, private keys ‚Üí `600`, `authorized_keys` ‚Üí `600`.

---

# üîë Authentication methods (how you log in)

* **Public-key** (recommended): client holds a private key; server has the public key in `authorized_keys`. No password needed. Best practice: use Ed25519 or RSA 4096 if Ed25519 not available.

  * Generate:

    ```bash
    ssh-keygen -t ed25519 -C "you@example.com" -f ~/.ssh/id_ed25519
    ```
  * Install public key:

    ```bash
    ssh-copy-id user@server.example.com
    # or manually: cat id_ed25519.pub >> ~/.ssh/authorized_keys
    ```
* **Password**: simple, less secure ‚Äî vulnerable to brute force and password reuse.
* **Keyboard-interactive**: often used to implement OTP/2FA (Google Authenticator).
* **Host-based**: client host is trusted (rare).
* **Certificates (OpenSSH CA)**: user/host keys signed by a CA ‚Äî scalable for large fleets.
* **Hardware tokens / FIDO2 / WebAuthn**: supported by modern OpenSSH for strong auth.

---

# üîÑ Key Exchange, Ciphers, MACs (crypto basics)

* SSH first performs a **key exchange (KEX)** (e.g., ECDH/Curve25519, or Diffie-Hellman) to agree symmetric keys without exposing them.
* SSH uses **symmetric encryption** (AES-GCM, ChaCha20-Poly1305 commonly) for bulk data confidentiality.
* **MACs** (message authentication codes) or AEAD (authenticated encryption) provide integrity.
* The server has a **host key** (RSA, ECDSA, Ed25519) ‚Äî used to verify server identity to the client.
* Recommendation: prefer **Ed25519** host/user keys and modern AEAD ciphers (ChaCha20-Poly1305 or AES-GCM). Disable old ciphers/MACs (3DES, RC4, MD5-based MACs).

---

# üõ°Ô∏è Host key verification and MITM prevention

* On first connect, the client gets the server‚Äôs host key and stores it in `~/.ssh/known_hosts`. Later connects compare the key to detect changes.
* If the host key changes, SSH warns of a possible **Man-in-the-Middle (MITM)** attack. Always verify out-of-band (phone, console, CSP dashboard) before accepting changed host keys.
* Useful commands:

  * Get host key fingerprint from remote host admin or via `ssh-keyscan`:

    ```bash
    ssh-keyscan -t ed25519 server.example.com | ssh-keygen -lf -
    ```
  * Show a public key‚Äôs fingerprint:

    ```bash
    ssh-keygen -lf /etc/ssh/ssh_host_ed25519_key.pub
    ```

---

# üîß Common SSH commands & examples

Connect (basic):

```bash
ssh user@host.example.com
```

Specify port / identity:

```bash
ssh -p 2222 -i ~/.ssh/id_ed25519 user@host.example.com
```

Verbose debug:

```bash
ssh -vvv user@host.example.com
```

Copy a key:

```bash
ssh-copy-id user@host.example.com
```

SCP (copy file):

```bash
scp localfile user@host:/remote/path/
```

SFTP (interactive file transfer):

```bash
sftp user@host
```

Rsync over SSH:

```bash
rsync -avz -e "ssh -p 2222" local/ user@host:/backup/
```

---

# üîÅ Port forwarding / Tunneling (very useful)

* **Local forward (-L)**: forwards a local port to a remote host/port via the SSH server.
  Example: forward local port 5901 to remote VNC:

  ```bash
  ssh -L 5901:localhost:5901 user@bastion.example.com
  ```
* **Remote forward (-R)**: forwards a port on the remote server back to your local machine:

  ```bash
  ssh -R 2222:localhost:22 user@server.example.com
  ```
* **Dynamic forward (-D)**: create a local SOCKS proxy:

  ```bash
  ssh -D 1080 user@bastion.example.com
  # then configure browser to use SOCKS5 proxy localhost:1080
  ```
* Run a tunnel in background: `ssh -N -f -L 8080:localhost:80 user@host` (`-N` no command, `-f` background).

---

# üß≠ Jump hosts / ProxyJump

Use a bastion/jump host to chain connections:

```bash
ssh -J jumpuser@jumphost targetuser@target.internal
```

Or set in `~/.ssh/config`:

```
Host internal-*
  ProxyJump jumpuser@jumphost.example.com
```

---

# üß∞ SSH client config (sample `~/.ssh/config`)

```text
Host bastion
  HostName bastion.example.com
  User alice
  IdentityFile ~/.ssh/id_ed25519
  Port 22

Host internal-host
  HostName internal.example.com
  User bob
  ProxyJump bastion
  ForwardAgent no
  ServerAliveInterval 60
```

---

# üõ†Ô∏è Example hardened `sshd_config` (server) ‚Äî annotated

```text
# /etc/ssh/sshd_config (minimal hardened)
Port 22
AddressFamily any
ListenAddress 0.0.0.0
PermitRootLogin no                # disallow direct root login
PasswordAuthentication no         # prefer publickey auth
PubkeyAuthentication yes
ChallengeResponseAuthentication no
PermitEmptyPasswords no
UsePAM yes
AllowUsers alice bob              # restrict users (optional)
Protocol 2                        # only SSH version 2
HostKey /etc/ssh/ssh_host_ed25519_key
KexAlgorithms curve25519-sha256@libssh.org,diffie-hellman-group-exchange-sha256
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com
MACs hmac-sha2-512-etm@openssh.com,umac-128-etm@openssh.com
LoginGraceTime 20
MaxAuthTries 3
ClientAliveInterval 300
ClientAliveCountMax 2
AllowTcpForwarding no             # disable if you don't need port forwarding
X11Forwarding no
PermitTunnel no
Banner /etc/issue.net
LogLevel VERBOSE
```

> After editing, restart: `sudo systemctl restart sshd` (or `sshd` service name on your distro).

---

# ‚ö†Ô∏è Security considerations & hardening checklist

* **Use public-key auth + disable password auth** (unless OTP/2FA used).
* **Use modern key types**: Ed25519 for user/host keys where possible.
* **Protect private keys**: use passphrases and `ssh-agent`.
* **Limit login users**: `AllowUsers` / `AllowGroups`.
* **Disable root login**: `PermitRootLogin no`.
* **Harden ciphers/MACs/KEX**: remove legacy algorithms.
* **Use Fail2Ban / rate limiting** to block brute force.
* **Keep OpenSSH updated** (security fixes matter).
* **Two-factor (OTP) or hardware keys** for sensitive accounts.
* **Monitor logs** (`/var/log/auth.log`, `journalctl -u sshd`) for suspicious access.
* **Consider SSH certificates** for large fleets (scalable and avoids per-host key distribution).
* **Avoid agent forwarding** on untrusted servers (it can allow later use of your agent).
* **Use bastion hosts** and `ProxyJump` to limit public exposed systems.

---

# üß™ Troubleshooting common issues

* **Connection refused**: server not listening or firewall blocking port ‚Üí check `sshd` status, `ss -tlnp | grep 22`, and firewall rules (ufw/iptables/cloud security group).
* **Permission denied (publickey)**: check `~/.ssh/authorized_keys` contents and permissions (`~/.ssh`=700, `authorized_keys`=600, private key local =600).
* **Host key verification failed**: host key changed ‚Äî verify with admin (possible legitimate reinstall or MITM).
* **Slow or hanging login**: DNS reverse lookups on server causing delay ‚Äî set `UseDNS no` in `sshd_config` or fix DNS.
* **Debugging**: use client `ssh -vvv user@host` to see which auth methods are attempted; check `/var/log/auth.log` or `journalctl -u sshd` on server.

---

# üîÅ Advanced / handy features

* **SSH Agent** (`ssh-agent`, `ssh-add`) caches decrypted private keys for the session.
* **Agent forwarding** (`ForwardAgent yes`) forwards agent to the server (use with caution).
* **ControlMaster / connection multiplexing** to reuse a single TCP connection for multiple SSH sessions:

  ```text
  Host *
    ControlMaster auto
    ControlPath ~/.ssh/cm-%r@%h:%p
    ControlPersist 10m
  ```
* **SFTP subsystem** (`sftp`) for secure file transfer.
* **SSHFS** mounts remote filesystem over SSH.
* **OpenSSH certificates & CA** scale better than distributing `authorized_keys` entries.

---

# ‚úÖ Quick reference (cheat sheet)

* Generate key: `ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519 -C "you@me"`
* Copy key: `ssh-copy-id user@host`
* Connect: `ssh -p 2222 user@host`
* Verbose: `ssh -vvv host`
* Local tunnel: `ssh -L 8080:localhost:80 user@host`
* Dynamic SOCKS: `ssh -D 1080 user@host`
* Background tunnel: `ssh -N -f -L 8080:localhost:80 user@host`
* Show host fingerprint: `ssh-keygen -lf /etc/ssh/ssh_host_ed25519_key.pub`
* Check sshd logs: `sudo journalctl -u sshd -e` or `sudo tail -F /var/log/auth.log`

---

# üßæ Final notes / study pointers

* Remember the **three layers** (Transport, Auth, Connection) ‚Äî understanding them helps to reason about problems and hardening.
* Prefer modern, authenticated, and encrypted algorithms (Ed25519, Curve25519, ChaCha20-Poly1305).
* Treat host key changes seriously; verify before accepting.
* Use `ssh -vvv` and server logs for debugging.
* For production, automate key distribution with configuration management or use SSH certificates.

---