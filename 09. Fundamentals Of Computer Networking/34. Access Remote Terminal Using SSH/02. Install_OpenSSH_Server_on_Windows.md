

# ü™ü Install OpenSSH Server on **Windows** ‚Äî step-by-step (deep dive) üîê

Below is a practical, in-depth walkthrough to **install, configure, secure and troubleshoot** the built-in OpenSSH *server* on modern Windows (Windows 10/11 and Windows Server 2019/2022+). I include exact PowerShell/GUI steps, why each step matters, file locations, permissions tips (Windows ACLs!), logging and common gotchas.

> Short summary: on modern Windows systems OpenSSH is a *Feature on Demand* you can add via **Settings** (GUI) or **PowerShell** (`Add-WindowsCapability`). After install you must start/enable `sshd`, ensure a firewall rule exists for TCP/22, put public keys in `~\.ssh\authorized_keys` (or `C:\ProgramData\ssh\administrators_authorized_keys`), and fix Windows ACLs so the server accepts keys. ([Microsoft Learn][1])

---

## ‚úÖ Prerequisites & what Windows versions this applies to

* Built-in OpenSSH server is included as a Windows optional feature starting with **Windows 10 (build 1809)** and Windows Server **2019** and later. You need **Administrator** privileges to install and configure. ([Microsoft Learn][2])

---

## 1) Check availability (quick check) üîé

Open PowerShell **as Administrator** (right-click ‚Üí Run as administrator) and run:

```powershell
# list OpenSSH capabilities available/installed
Get-WindowsCapability -Online | Where-Object Name -like 'OpenSSH*'
```

This shows `OpenSSH.Client~~~~0.0.1.0` and `OpenSSH.Server~~~~0.0.1.0` and whether they're `Present` or `NotPresent`. ([Microsoft Learn][1])

---

## 2) Install OpenSSH Server (GUI or PowerShell) üõ†Ô∏è

**GUI (Settings)**

* Settings ‚Üí Apps ‚Üí Optional features ‚Üí *Add a feature* ‚Üí search **OpenSSH Server** ‚Üí Install. (Good for desktops.)

**PowerShell (recommended / scriptable)** ‚Äî run elevated:

```powershell
# Install server (downloads from Windows update)
Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0

# (alternative using DISM)
dism /Online /Add-Capability /CapabilityName:OpenSSH.Server~~~~0.0.1.0
```

Both approaches install the Microsoft packaged OpenSSH binaries into the system. ([Microsoft Learn][1])

---

## 3) Start the sshd service & enable on boot üö¶

After install you must start `sshd` and usually make it automatic:

```powershell
# Start now
Start-Service sshd

# Make it start on boot
Set-Service -Name sshd -StartupType 'Automatic'

# Check status
Get-Service -Name sshd
```

If you want the ssh *agent* (for forwarded keys) also enable `ssh-agent`. ([Microsoft Learn][1])

---

## 4) Firewall: allow SSH (port 22) üîê‚ûïüß≠

Installation **usually creates** a firewall rule `OpenSSH-Server-In-TCP` that permits inbound TCP/22. Verify it and if missing create it:

```powershell
# verify the rule exists
Get-NetFirewallRule -Name "OpenSSH-Server-In-TCP" -ErrorAction SilentlyContinue

# if missing, create it
New-NetFirewallRule -Name 'OpenSSH-Server-In-TCP' `
  -DisplayName 'OpenSSH Server (sshd)' -Enabled True `
  -Direction Inbound -Protocol TCP -Action Allow -LocalPort 22
```

If you change the SSH port in `sshd_config`, you must update the firewall rule accordingly. ([Microsoft Learn][1])

---

## 5) Files & important paths ‚Äî where things live üóÇÔ∏è

* `sshd` executable and OpenSSH tools: `%WINDIR%\System32\OpenSSH\` (e.g. `C:\Windows\System32\OpenSSH\sshd.exe`, `ssh.exe`, `ssh-keygen.exe`).
* Server config (sshd_config): `%PROGRAMDATA%\ssh\sshd_config` ‚Üí **C:\ProgramData\ssh\sshd_config**. If missing, sshd will generate defaults on first run. ([Microsoft Learn][2])
* Host keys (server keys) are stored in **C:\ProgramData\ssh** (generated the first time sshd starts). ([Microsoft Learn][3])
* Per-user authorized keys: `%USERPROFILE%\.ssh\authorized_keys` (e.g. `C:\Users\alice\.ssh\authorized_keys`). There's also a machine-wide `C:\ProgramData\ssh\administrators_authorized_keys` used by admin accounts if configured in `sshd_config`. ([Super User][4])

---

## 6) Configure `sshd_config` (what to tweak) üß≠

Open `C:\ProgramData\ssh\sshd_config` as Administrator (Notepad run "as admin") and consider:

* `Port 22` ‚Äî change if you want a nonstandard port.
* `PasswordAuthentication no` ‚Äî *prefer* disabling passwords once keys work.
* `PubkeyAuthentication yes` ‚Äî enable public key auth.
* `AuthorizedKeysFile %h/.ssh/authorized_keys` ‚Äî default on Windows, `%h` expands to the user profile.
* `Subsystem sftp sftp-server.exe` ‚Äî SFTP config if you need it.

After editing, restart sshd:

```powershell
Restart-Service sshd -Force
```

> Note: sshd reads the config only at start ‚Äî changes require restart. ([Microsoft Learn][2])

---

## 7) Key-based auth ‚Äî create `~\.ssh\authorized_keys` and copy your public key üîë

**On the client** (Linux/macOS/Windows with OpenSSH client):

```bash
ssh-keygen -t ed25519 -C "you@example.com"    # generate keypair
# copy public key to server (if you have scp/pscp/WinSCP)
scp ~/.ssh/id_ed25519.pub user@windows-host:C:\Users\user\Desktop\id_ed25519.pub
```

**On the Windows server (as the target user)**:

```powershell
# make .ssh dir (run as the target user or as admin and set owner correctly)
New-Item -ItemType Directory -Force -Path $env:USERPROFILE\.ssh

# append public key into authorized_keys
Get-Content C:\path\to\id_ed25519.pub | Out-File -FilePath $env:USERPROFILE\.ssh\authorized_keys -Encoding ascii -Append
```

You can also copy the public key text and paste into the authorized_keys file in Notepad (make sure encoding is UTF-8 / ASCII, no extra line breaks). ([Microsoft Learn][3])

---

## 8) Windows ACLs ‚Äî the *crucial* gotcha (why keys often fail) ‚ö†Ô∏è

On Windows OpenSSH is **picky about file permissions**. If ACLs are too permissive, `sshd` will ignore `authorized_keys` silently and fall back to password auth.

**Rules of thumb (common, safe approach):**

* `C:\ProgramData\ssh\administrators_authorized_keys` (if used) should have **only** `SYSTEM` and `Administrators` entries (FullControl). No other users/groups.
* Per-user `%USERPROFILE%\.ssh\authorized_keys` should be owned by the user and either: only `SYSTEM` and the user (FullControl), or otherwise be restrictive so only the user and SYSTEM can modify it.
* Host key files under `C:\ProgramData\ssh` are created with correct ACLs automatically. ([GitHub][5])

**You can fix ACLs with PowerShell (example ‚Äî run as Admin):**

```powershell
# Example: set authorized_keys to be only writable by the user and SYSTEM
$auth = "$env:USERPROFILE\.ssh\authorized_keys"
# create file if missing
If (!(Test-Path $auth)) { New-Item -ItemType File -Path $auth -Force }

# reset ACL and set two rules: SYSTEM full control, current user full control
$acl = New-Object System.Security.AccessControl.FileSecurity
$acl.SetAccessRuleProtection($true, $false)   # disable inheritance
$ruleSys = New-Object System.Security.AccessControl.FileSystemAccessRule("SYSTEM","FullControl","Allow")
$ruleUser = New-Object System.Security.AccessControl.FileSystemAccessRule($env:USERNAME,"FullControl","Allow")
$acl.AddAccessRule($ruleSys)
$acl.AddAccessRule($ruleUser)
Set-Acl -Path $auth -AclObject $acl
```

If you prefer GUI, Right-click ‚Üí Properties ‚Üí Security ‚Üí Advanced ‚Üí Disable inheritance ‚Üí remove extra entries ‚Üí add `SYSTEM` and the actual user with Full control.
(If you misconfigure ACLs you can lock yourself out ‚Äî proceed carefully and keep an Administrator console open.) ([GitHub][5])

---

## 9) Default shell when users log in (optional) üñ•Ô∏è

By default Windows‚Äô OpenSSH may give a `cmd.exe` shell. To set PowerShell, WSL, or another shell as the default shell for SSH logins, set registry key:

```powershell
New-ItemProperty -Path "HKLM:\SOFTWARE\OpenSSH" -Name DefaultShell `
  -Value "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe" -PropertyType String -Force
```

You can also set `DefaultShellCommandOption` and `DefaultShellEscapeArguments` if required. After changing, **restart sshd**. ([Microsoft Learn][2])

---

## 10) Logging & troubleshooting tips üêû

* **Where to look:** OpenSSH on Windows logs to **Event Viewer** by default under *Applications and Services Logs ‚Üí OpenSSH* (Admin/Operational). For deeper file logging you can set `SyslogFacility LOCAL0` and `LogLevel DEBUG3` in `sshd_config` and logs will appear under `%ProgramData%\ssh\logs`. ([Super User][6])
* **Useful client test:** from a *client* run `ssh -vvv user@host` to see which auth methods are attempted.
* **Common messages:**

  * `Permission denied (publickey)` ‚Üí usually authorized_keys format, path, or ACL issue.
  * `Connection refused` ‚Üí sshd not running or firewall blocking.
  * `Host key verification failed` ‚Üí host key changed (possible MITM) ‚Äî verify out-of-band.

---

## 11) Quick checklist / one-liner summary (copy-paste friendly)

```powershell
# 1. Install (Admin)
Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0

# 2. Enable & start service
Start-Service sshd
Set-Service -Name sshd -StartupType 'Automatic'

# 3. Ensure firewall rule exists (create if missing)
if (!(Get-NetFirewallRule -Name "OpenSSH-Server-In-TCP" -ErrorAction SilentlyContinue)) {
  New-NetFirewallRule -Name 'OpenSSH-Server-In-TCP' -DisplayName 'OpenSSH Server (sshd)' `
    -Enabled True -Direction Inbound -Protocol TCP -Action Allow -LocalPort 22
}

# 4. Create .ssh and authorized_keys (as the target user)
New-Item -ItemType Directory -Force -Path $env:USERPROFILE\.ssh
# copy/append the public key into $env:USERPROFILE\.ssh\authorized_keys
```

(See earlier sections for ACL commands and sshd_config editing.) ([Microsoft Learn][1])

---

## 12) Security hardening recommendations üîê

* Use **public-key** auth and set `PasswordAuthentication no` when ready. ([Microsoft Learn][3])
* Use Ed25519 keys where possible.
* Limit which users may SSH in (`AllowUsers`/`AllowGroups` in `sshd_config`).
* Keep Windows and OpenSSH patched/updated.
* Consider moving SSH to a nonstandard port + restrict inbound IPs in firewall (defense in depth).
* Monitor OpenSSH event logs and add alerting for suspicious logins.

---

## 13) Common gotchas & fixes

* **Authorized keys ignored** ‚Üí fix file ACLs (see section 8). ([GitHub][5])
* **No sshd logs visible** ‚Üí check Event Viewer ‚Üí Applications and Services Logs ‚Üí OpenSSH, or set file logging in `sshd_config` and restart. ([GitHub][7])
* **sshd won‚Äôt start after Windows update** ‚Üí check `C:\ProgramData\ssh\logs` permissions and `sshd` Event Log entries; some updates can change ACLs under `%ProgramData%\ssh`. ([Server Fault][8])

---

## Helpful references (official / authoritative)

* Microsoft: *Get started with OpenSSH Server for Windows* (install & first use). ([Microsoft Learn][1])
* Microsoft: *OpenSSH Server configuration for Windows* (sshd_config specifics). ([Microsoft Learn][2])
* Microsoft: *Key-Based Authentication in OpenSSH for Windows* (keys, authorized_keys). ([Microsoft Learn][3])
* Win32-OpenSSH GitHub wiki: *Security / ACL guidance* (icacls/ACL examples). ([GitHub][5])

---