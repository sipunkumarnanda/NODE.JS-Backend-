

# Connecting multiple SSH servers ‚Äî deep dive üîêüß≠

# 1) File location & permissions ‚úÖ

* **Path:** `~/.ssh/config` (per-user)
* **Permissions:** `~/.ssh` ‚Üí `700` and `~/.ssh/config` ‚Üí `600` (private keys also `600`).

  ```bash
  chmod 700 ~/.ssh
  chmod 600 ~/.ssh/config
  chmod 600 ~/.ssh/id_rsa
  ```

  Proper permissions prevent SSH from ignoring keys or refusing to use the config. üîí

---

# 2) Minimal example & how it works üß©

Put entries like this in `~/.ssh/config`:

```text
Host local-server
    HostName 192.0.2.10
    User sipun
    IdentityFile ~/.ssh/mykey.pem
```

* `Host local-server` ‚Äî a **shortcut name** you type: `ssh local-server`.
* `HostName` ‚Äî the real host (IP or DNS).
* `User` ‚Äî username to log in (so you don't need `ssh sipun@192.0.2.10`).
* `IdentityFile` ‚Äî which private key file to use for this host.

You can put many entries in this file ‚Äî one per server (or use patterns, see below). üìÇ

---

# 3) Useful directives (and what they do) üõ†Ô∏è

* `Host <pattern>` ‚Äî start a block. Example patterns: `host1`, `*.example.com`, `server?`. Multiple patterns allowed: `Host server1 server2`.
* `HostName <host>` ‚Äî real hostname or IP.
* `User <username>` ‚Äî login user.
* `Port <port>` ‚Äî SSH port (default 22).
* `IdentityFile <path>` ‚Äî path to private key (`~` is fine).
* `ProxyJump <jump>` (or `-J`) ‚Äî simple jump/bastion host: `ProxyJump bastion.example.com`.
* `ProxyCommand <command>` ‚Äî older, more flexible way to proxy (e.g., `nc`).
* `ForwardAgent yes/no` ‚Äî forwards your SSH agent (be careful, it's a security risk on untrusted hosts).
* `LocalForward <local> <remote>` / `RemoteForward <remote> <local>` ‚Äî port forwarding.
* `StrictHostKeyChecking yes/no/accept-new` ‚Äî controls host key prompts/behavior.
* `ControlMaster`, `ControlPath`, `ControlPersist` ‚Äî connection multiplexing (speed up multiple SSH sessions).
* `Include <file>` ‚Äî include other config files (useful for splitting configs).
* `IdentityAgent` ‚Äî specify agent socket.
* `ProxyUseFdpass` ‚Äî advanced; pass file descriptors to proxy.
* `CanonicalizeHostname` and `CanonicalDomains` ‚Äî hostname transformations.

---

# 4) Handy examples üßæ

Multiple servers:

```text
# personal laptop to home server
Host home
    HostName 203.0.113.50
    User sipun
    IdentityFile ~/.ssh/home_key

# company servers using different keys
Host prod-*
    User deploy
    IdentityFile ~/.ssh/prod_key

Host prod-web1
    HostName web1.prod.example.com

Host prod-db1
    HostName db1.prod.example.com
```

Use a bastion (jump) host:

```text
Host bastion
    HostName bastion.example.com
    User jumpuser
    IdentityFile ~/.ssh/bastion_key

Host internal-*
    ProxyJump bastion
    User internaluser
    IdentityFile ~/.ssh/internal_key
```

Wildcard pattern + Host-specific override:

```text
Host *.example.com
    User sipun
    IdentityFile ~/.ssh/example_key

Host special.example.com
    HostName special.example.com
    Port 2222
    IdentityFile ~/.ssh/special_key
```

---

# 5) Shortcuts & tokens üîÅ

SSH config supports tokens inside some directives:

* `%h` = target hostname
* `%p` = port
* `%r` = remote username

Example:

```text
Host alias
    HostName %h.example.com
```

(Used less often ‚Äî mostly helpful in complex templates.)

---

# 6) Connection multiplexing (speed) ‚ö°

Add to top of your config for multiplexing:

```text
Host *
    ControlMaster auto
    ControlPath ~/.ssh/cm-%r@%h:%p
    ControlPersist 10m
```

This lets subsequent SSH connections reuse the same TCP/SSH session ‚Äî faster and fewer reconnections.

---

# 7) Managing keys & agent usage üîë

* Add keys to your agent: `ssh-add ~/.ssh/mykey` (then `ssh local-server` uses agent key if configured).
* Or force a key with `ssh -i ~/.ssh/mykey user@host` (overrides config).
* To copy a public key to a remote server: `ssh-copy-id -i ~/.ssh/id_rsa.pub user@host` (adds to `~/.ssh/authorized_keys`).

Be careful with `ForwardAgent yes` ‚Äî it allows a remote server to use your agent to authenticate elsewhere.

---

# 8) Debugging & testing üêû

* See what SSH is doing: `ssh -v local-server` (or `-vvv` for more verbose).
* Display *effective* settings for a host: `ssh -G local-server` ‚Äî shows the merged configuration SSH will use. Super useful.
* If a key is ignored, check permissions (`ssh -v` shows "bad permissions" warnings).

---

# 9) Security tips üõ°Ô∏è

* Keep private keys safe (`600`).
* Use passphrases for private keys (use `ssh-agent` to avoid retyping).
* Avoid `ForwardAgent` on untrusted hosts.
* Consider using `Match` blocks or `Include` to separate work/personal keys.
* Use `StrictHostKeyChecking=accept-new` or `yes` (less convenient but safer).

---

# 10) Example full config (copy & adapt) üìã

```text
# ~/.ssh/config

# global defaults
Host *
    AddKeysToAgent yes
    ForwardAgent no
    ServerAliveInterval 60
    ControlMaster auto
    ControlPath ~/.ssh/cm-%r@%h:%p
    ControlPersist 10m

# bastion (jump) host
Host bastion
    HostName bastion.example.com
    User jumpuser
    IdentityFile ~/.ssh/bastion_key

# internal servers via bastion
Host internal-*
    ProxyJump bastion
    User internaluser
    IdentityFile ~/.ssh/internal_key

# personal home server
Host home
    HostName 203.0.113.50
    User sipun
    IdentityFile ~/.ssh/home_key

# wildcard for domain
Host *.example.com
    User sipun
    IdentityFile ~/.ssh/example_key

# override for special host
Host special.example.com
    HostName special.example.com
    Port 2222
    IdentityFile ~/.ssh/special_key
```

Then connect with:

```bash
ssh home
ssh prod-web1
ssh internal-db1
```

---

# 11) Quick checklist before you connect ‚úÖ

* `~/.ssh/config` exists and is `600`.
* Private key exists and `600`.
* If using `ProxyJump`, make sure the jump host is reachable.
* Use `ssh -v host` if something fails.

---